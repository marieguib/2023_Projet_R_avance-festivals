---
title: "Projet R avanc√©"
author: "Margaux Bailleul - Marie Guibert"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r, message = FALSE}
library(rvest)
library(tidyverse)
library(jsonlite)
library(sf)
library(stringr)
library(jpeg)
library(png)
```

N.B. : Au format PDF, certaines de nos sorties ne sont pas affich√©es enti√®rement. Afin de les avoir en entier, n'h√©sitez pas √† √©x√©cuter le code Rmd.

# Pr√©sentation de notre projet

Lors de cette √©tude, nous avons abord√© un sujet qui nous tient particuli√®rement √† coeur : les festivals de musique. En effet, nous avons choisi d'aborder ce sujet et de nous focaliser les festivals de musique amplifi√©es et √©lectroniques. Ces √©v√®nements ont une port√©e culturelle tr√®s importante et un impact √©conomique dans le monde entier.

# Donn√©es provenant de l'API

Premi√®rement, nous avons choisi une API nationale r√©pertoriant tous les festivals de musique de France. Nous avons affin√© notre √©tude en ne s√©lectionnant que les musiques amplifi√©es ou √©lectroniques. 

Nous allons donc proc√©der √† l'√©tude de ce panorama de festivals !

## Extraction des donn√©es via une API

```{r}
url_festival <- "https://data.culture.gouv.fr/api/records/1.0/search/?dataset=panorama-des-festivals&q=&rows=-1&facet=region&facet=domaine&facet=complement_domaine&facet=departement&facet=mois_habituel_de_debut"
```

Nous utilisons le package **jsonlite** pour extraire les donn√©es de l'API.

```{r echo=TRUE, results='hide'}
contenu <- fromJSON(url_festival)
df_festivals <- contenu$records$fields
glimpse(df_festivals)
```

Tout d'abord, visualisons nos donn√©es de fa√ßon globale sans effectuer de modifications :

```{r}
head(df_festivals,3)
```

## Nettoyage de la base de donn√©es

Premi√®rement, nous nous focalisons sur les donn√©es concernant les musiques amplifi√©es ou √©lectroniques 

```{r}
df_festivals <- df_festivals |> 
  filter(complement_domaine == "Musiques amplifi√©es ou √©lectroniques")
dim(df_festivals)
```
Nous avons maintenant une base de donn√©es avec 629 lignes et 36 colonnes.

Afin de faciliter notre √©tude, nous avons choisi de supprimer certaines colonnes de la base de donn√©es. \
De plus, certaines informations sont redondantes, nous avons donc choisi de les omettre aussi. Par exemple, le domaine correspond aux musiques actuelles et plus sp√©cialement aux musiques amplifi√©es ou √©lectroniques (complement_domaine). Ces deux colonnes n'√©taient donc pas pertinentes pour la suite de notre analyse.

```{r}
df_festivals <-df_festivals |> 
  select(coordonnees_insee,date_de_fin_ancien,nom_departement,departement,periodicite,mois_habituel_de_debut,code_postal,libelle_commune_pour_calcul_cp_insee,date_debut_ancien,region,nom_de_la_manifestation,site_web)
head(df_festivals,3)
```

Deuxi√®mement, nous allons transformer les variables caract√®res en facteurs pour effectuer des traitements de donn√©es et des graphiques plus facilement.

```{r} 
# str(df_festivals) # permet de conna√Ætre le type de chaque variable du dataframe
df_festivals[c("nom_departement", 
               "periodicite",
               "code_postal",
               "libelle_commune_pour_calcul_cp_insee",
               "region")] <- lapply(df_festivals[c("nom_departement", 
               "periodicite",
               "code_postal",
               "libelle_commune_pour_calcul_cp_insee",
               "region")], as.factor)
# str(df_festivals)
```

Dans cette √©tude, nous allons nous concentrer sur les festivals annuels. Nous choisissons donc de ne pas prendre en compte les autres modalit√©s de la variable **periodicite**.

```{r}
table(df_festivals$periodicite)


df_festivals <- df_festivals |> 
  filter(periodicite == "Annuelle") |> # filtrage pour n'avoir que les festivals annuels
  select(-periodicite) # suppression de la colonne periodicite 
                       # car les informations sont redondantes √† pr√©sent

# V√©rification : 
# table(df_festivals$periodicite)
```

Nous allons extraire les coordonn√©es GPS de la variable **coordonnes_insee** afin de la scinder en deux colonnes : latitude et longitude. Cette √©tape nous permettra de r√©aliser plus facilement notre carte par la suite. 

```{r}
# On extrait d'abord les coordonn√©es et on cr√©√© un dataframe contenant la latitude et la longitude
coord_df <- data.frame(matrix(unlist(sapply(df_festivals$coordonnees_insee, function(x) {
  unlist(strsplit(paste(x, collapse = ", "), ", "))
})), ncol = 2, byrow = TRUE))

coord_df <- coord_df |> 
  rename("longitude" = X1, "latitude" = X2)

# V√©rification de la bonne forme du dataframe
# coord_df

# On concat√©ne les deux dataframes 
df_festivals <- bind_cols(df_festivals,coord_df)
# df_festivals

# On supprime la colonne coordonnees_insee car on ne la r√©utilisera pas 
df_festivals <- df_festivals |> 
  select(-coordonnees_insee)

# V√©rification
head(df_festivals,3)
```

### R√©cup√©ration de la base de donn√©es finale

Afin d'avoir une base de donn√©es accessible √† tous, nous avons d√©cider d'exporter notre base de donn√©es apr√®s traitement en format csv. Cette √©tape n'est pas indispensable mais elle permet de cr√©er une base de donn√©es "propre".

```{r}
write.table(df_festivals,"donnees_festivals.csv",sep=";")
```



## Quelques graphiques

Tout d'abord, nous allons pouvoir visualiser les r√©gions avec le plus d'√©v√®nements. 

```{r}
# Calculer les fr√©quences de chaque r√©gion
freq <- table(df_festivals$region)

# Cr√©er un dataframe avec les fr√©quences de chaque r√©gion
df_regions <- data.frame(table(df_festivals$region)) |> 
  rename(Region = Var1, Frequence = Freq) |> 
  mutate(Pourcentage = round(Frequence / sum(Frequence) * 100, 1)) |> 
  arrange(-Frequence) # on trie selon le nombre de festivals dans la r√©gion
head(df_regions,3)
```

Ce tableau nous pr√©sente les trois r√©gions organisant le plus de festivals de musique √©lectroniques ou amplifi√©es. En premi√®re place, nous retrouvons la r√©gion Auvergne-Rh√¥ne-Alpes avec 83 festivals mis en place chaque ann√©e. Ensuite, l'Ile de France en seconde place avec 62 festivals et l'Occitanie avec 61 festivals. 

Ce diagramme en barres nous permet d'avoir une information plus exhaustive au du nombre de festivals annuels dans chaque r√©gion de France.

```{r warning=FALSE}
ggplot(df_regions, aes(x = reorder(Region,-Frequence), y = Frequence)) +
  geom_bar(stat = "identity") +
  labs(title = "Fr√©quence des festivals dans chaque r√©gion fran√ßaise", x = "R√©gion", y = "Nombre de festivals") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(fill=FALSE) 
```

Nous allons maintenant repr√©senter le nombre de festivals par d√©partement.

```{r}
# Cr√©ation de la base de donn√©es comportant tous les d√©partements 
# de France ainsi que leurs caract√©ristiques 
dpt <- read_sf("dpt")
```

```{r}
# Cr√©ation d'un tableau de fr√©quence des festivals par d√©partement
# freq <- table(df_festivals$departement)

# Cr√©ation d'un dataframe avec le nombre de festivals par d√©partement
df_depart <- data.frame(table(df_festivals$departement)) |> 
  rename(ID_GEOFLA = Var1, Frequence = Freq)|>  # renommage des colonnes
  mutate(Pourcentage = round(Frequence / sum(Frequence) * 100, 1)) # cr√©ation d'une variable en pourcentage

head(df_depart,3)
```

```{r}
# Cr√©ation du dataframe final pour r√©aliser la carte
france_map_count <- merge(dpt, df_depart, by.x = "CODE_DEPT",by.y = "ID_GEOFLA", all.x = TRUE)
head(france_map_count,3)
```


```{r}
# Carte
ggplot(france_map_count) + geom_sf(aes(fill=Frequence)) +
  scale_fill_continuous(low="yellow",high="red")+theme_void()
```

Cette carte est bien en ad√©quation avec les donn√©es de r√©gion que nous avons vu auparavant. Le r√©gion Auvergne-Rh√¥ne Alpes pr√©sente de nombreux festivals, tout comme l'Ile de France. Par ailleurs, nous pouvons aussi remarquer qu'en Ille-et-Vilaine de nombreux festivals ont aussi lieu ! 

N.B. : Cette carte montre qu'il y a quelques d√©partements sans correspondance, nous avons d√©cid√© de ne pas en tenir compte.


Nous allons maintenant nous int√©resser au nombre de festivals par mois : 

```{r}
# Cr√©ation d'un tableau avec le nombre de festivals par mois
freq <- table(df_festivals$mois_habituel_de_debut)

df_mois <- data.frame(table(df_festivals$mois_habituel_de_debut)) |> 
  rename(Mois = Var1, Frequence = Freq) |> 
  mutate(Pourcentage = round(Frequence / sum(Frequence) * 100, 1)) #Cr√©ation d'une variable en pourcentage
df_mois
```

```{r}
ggplot(df_mois, aes(x = Mois, y = Frequence)) +
  geom_bar(stat = "identity") +
  labs(title = "Nombre de festivals par mois", x = "Mois", y = "Nombre de festivals") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(fill=FALSE) 
```
Nous observons que plus les beaux jours arrivent, plus le nombre de festivals augmente. Cette conclusion est bien coh√©rente avec nos donn√©es. 

# Donn√©es provenant d'un site web

Dans un second temps, nous avons choisi d'√©tudier deux sites web concernant les festivals les plus reconnus en France et un autre au sujet du festival le plus connu de France : l'ElectroBeach Festival. 

## Extraction des donn√©es via un site web

```{r}
site_festivals <- "https://martinbeatz.com/festivals-electro-france/"
```

```{r}
festival_html <- read_html(site_festivals)
```

Gr√¢ce √† cette page web, nous allons pouvoir √©tablir les festivals les plus en vogue.
Nous avons choisi d'utiliser **xpath**  pour se d√©placer librement dans l‚Äôarbre. 

```{r}
listes_festivals <- festival_html |> 
  html_nodes(xpath = "//h2") |> 
  html_text()
# listes_festivals

cat("Les festivals les plus recommand√©s sont :", paste("\n", listes_festivals))
```

Nous allons maintenant r√©cup√©rer les diff√©rents lieux des festivals : 

```{r}
liste_lieux <- festival_html |> 
  html_nodes(xpath = "//*[@id='post-2934']/div/div/div/p[position()=4 or position()=9 or position()=14 or position()=18 or position()=23 or position()=27 or position()=32 or position()=37 or position()=42 or position()=47 or position()=52 or position()=57 or position()=62 or position()=67 or position()=72 or position()=77 or position()=82 or position()=87]/text()[1]") |> 
  html_text()
liste_lieux <- gsub("Lieu : ", "", liste_lieux)
liste_lieux
```

Puis nous allons r√©cup√©rer les diff√©rentes dates des festivals : 

```{r}
liste_dates_prov <- festival_html |> 
  html_nodes(xpath = "//*[@id='post-2934']/div/div/div/p[position()=4 or position()=9 or position()=14 or position()=18]/strong | //*[@id='post-2934']/div/div/div/p[23]/text()[2] | //*[@id='post-2934']/div/div/div/p[position()=27]/strong | //*[@id='post-2934']/div/div/div/p[32]/text()[2] | //*[@id='post-2934']/div/div/div/p[position()=37 or position()=42 or position()=47 or position() = 52]/strong | //*[@id='post-2934']/div/div/div/p[57]/text()[2] | //*[@id='post-2934']/div/div/div/p[position()=62 or position()=67 or position()=72 or position()=77]/strong | //*[@id='post-2934']/div/div/div/p[82]/text()[2] | //*[@id='post-2934']/div/div/div/p[87]/strong") |> 
  html_text()
liste_dates <- gsub("\nDate : ", "", liste_dates_prov)
liste_dates
```

Nous allons alors, pour chaque festival, afficher sa date et son lieu.

```{r}
for(i in seq_along(listes_festivals)){
    cat("Le festival", listes_festivals[[i]], "aura lieu les", liste_dates[[i]], "√†", liste_lieux[[i]], "\n")
}
```

## Zoom sur le Electrobeach Music Festival

Electrobeach Music Festival est le plus grand **festival fran√ßais de musiques √©lectroniques** fond√© par Alain Ferrand. Il a lieu au Barcar√®s en face du Lydia, le plus vieux paquebot du monde ensabl√© depuis 1967. 

```{r}
# url du site web
site_electro_beach <- "https://fr.wikipedia.org/wiki/Electrobeach_Music_Festival"
```

```{r}
electro_beach_html <- read_html(site_electro_beach)
```

### L'histoire de l'Electro Beach Festival 

Nous allons maintenant chercher √† en savoir un peu plus sur ce festival, en commen√ßant par son histoire : 

```{r}
electro_beach_html |> 
  html_nodes(xpath ="/html/body/div[2]/div/div[3]/main/div[3]/div[3]/div[1]/p[3]") |> 
  html_text()
```

Lorsque ce festival a √©t√© cr√©√©, il √©tait d'une plus petite envergure et d'une dur√©e plus courte qu'actuellement. C'est ce que nous pr√©cise ce paragraphe : 

```{r}
electro_beach_html |> 
  html_nodes(xpath = "/html/body/div[2]/div/div[3]/main/div[3]/div[3]/div[1]/p[4]") |> 
  html_text()
```

```{r}
electro_beach_html |> 
  html_nodes(xpath = "//*[@id='mw-content-text']/div[1]/ul[1]/li[1]/text()[1]") |> 
  html_text()
```


Le festival a eu lieu pour la derni√®re fois en 2019, avant la pand√©mie du Covid-19. Sur cette page web, nous pouvons voir un article d√©di√© √† ce sujet. 

```{r}
electro_beach_html |> 
  html_nodes(xpath = "/html/body/div[2]/div/div[3]/main/div[3]/div[3]/div[1]/p[8]") |> 
  html_text()
```

La derni√®re √©dition a accueilli de nombreux festivaliers :

```{r}
electro_beach_html |> 
  html_nodes(xpath = "/html/body/div[2]/div/div[3]/main/div[3]/div[3]/div[1]/ul[1]/li[9]") |> 
  html_text()
```

Cependant, nous pouvons observer que certaines √©ditions n'ont pas eu lieu √† cause de la crise sanitaire.

```{r}
electro_beach_html |> 
  html_nodes(xpath = "/html/body/div[2]/div/div[3]/main/div[3]/div[3]/div[1]/ul[1]/li[10]") |> 
  html_text()
```

Nous pouvons visualiser l'√©volution du nombre de festivaliers √† l'Electro Beach Club. 

```{r}
freq <- electro_beach_html |> 
  html_nodes("ul:first-of-type li") |> 
  html_text() |>
  str_extract("\\d+\\s\\d+") |> 
  na.omit() # suppression des donn√©es manquantes
frequentation <- freq[1:9]
annees <- 2011:2019

df <- data.frame(annees,frequentation) |> 
  rename(Annee = annees, Frequentation = frequentation)
df
```

Nous pouvons constater que le nombre de festivaliers le plus important est en 2017. De plus, nous observons une forte √©volution entre sa cr√©ation et les derni√®res √©ditions !


### Les diff√©rents logos de l'Electro Beach Music Festival 

N.B. : Les logos pr√©sentent une qualit√© m√©diocre d√ªe aux difff√©rents traitements r√©alis√©s. De plus, leur dimension est assez petite sur wikip√©dia, leur agrandissement a donc des cons√©quences sur leur visualisation.

Nous avons choisi de repr√©senter les diff√©rents logos du festivals.

```{r warning=FALSE}
logo1 <- electro_beach_html |>
   html_nodes(xpath = "//*[@id='mw-content-text']/div[1]/ul[2]/li[1]/div/div[1]/div/a/img") |>
   html_attr("src") # r√©cup√©ration du lien de l'image 
logo1

# download.file(paste0("http:", logo1), destfile = "logo_electrobeach.jpg") # enregistrement du logo sur l'ordinateur

img <- readJPEG("logo_electrobeach.jpg") # lecture de l'image

plot(0, 0, type = "n", xlim = c(0, 1), ylim = c(0, 1), xlab = "", ylab = "") # cr√©ation d'un graphique pour afficher le logo
rasterImage(img, 0, 0, 0.5, 1) # position de l'image sur le graphique
```


```{r}
logo2 <- electro_beach_html |> 
   html_nodes(xpath = "//*[@id='mw-content-text']/div[1]/ul[2]/li[2]/div/div[1]/div/a/img") |> 
   html_attr("src")
logo2
# download.file(paste0("http:", logo2), destfile = "logo_electrobeach2.jpg")
img <- readJPEG("logo_electrobeach2.jpg")
plot(0, 0, type = "n", xlim = c(0, 1), ylim = c(0, 1), xlab = "", ylab = "")
rasterImage(img, 0, 0, 0.5, 1)
```

```{r}
logo3 <- electro_beach_html |>
   html_nodes(xpath = "//*[@id='mw-content-text']/div[1]/ul[2]/li[3]/div/div[1]/div/a/img") |>
   html_attr("src")
 logo3
 
#  download.file(paste0("http:", logo3), destfile = "logo_electrobeach3.jpg")
 
img <- readJPEG("logo_electrobeach3.jpg")

plot(0, 0, type = "n", xlim = c(0, 1), ylim = c(0, 1), xlab = "", ylab = "")
rasterImage(img, 0, 0, 0.5, 1)
```

```{r}
logo4 <- electro_beach_html |>
   html_nodes(xpath = "//*[@id='mw-content-text']/div[1]/ul[2]/li[4]/div/div[1]/div/a/img") |>
   html_attr("src")
 logo4
 
#  download.file(paste0("http:", logo4), destfile = "logo_electrobeach4.jpg")
 
 img <- readJPEG("logo_electrobeach4.jpg")
 
 plot(0, 0, type = "n", xlim = c(0, 1), ylim = c(0, 1), xlab = "", ylab = "")
 rasterImage(img, 0, 0, 0.5, 1)
```

Le logo de l'ann√©e 2015 n'est pas disponible sur le site de wikip√©dia. Cependant, nous avons trouv√© √ßa important de montrer le logo actuel du festival, en place depuis 2016. 

```{r}
electrobeach_site <- "https://www.electrobeach.com" # site web o√π se trouve le logo
electro_beach_site_html <- read_html(electrobeach_site)
logo2016 <- electro_beach_site_html |>
   html_nodes(xpath = "//*[@id='header_main']/div/div/span/a/img") |>
   html_attr("src")
logo2016

# download.file(paste0(logo2016), destfile = "logo_electrobeach2016.png")

img <- readPNG("logo_electrobeach2016.png")

plot(0, 0, type = "n", xlim = c(0, 1), ylim = c(0, 1), xlab = "", ylab = "")
rasterImage(img, 0, 0, 0.5, 1)
```


# Mise en relation entre le JSON et le site des festivals 

Nous pouvons maintenant mettre en lien le fichier JSOn et le web-scrapping r√©alis√© sur les sites web. 
En effet, nous allons chercher les festivals en commun entre ces deux sources. Pour y parvenir, nous devons mettre les champs dans le m√™me format. 

```{r}
# Mise en minuscules des champs
listes_festivals_low <- str_to_lower(listes_festivals)
listes_festivals_low
```

```{r}
# Mise en minuscules des champs
df_festivals_low <- str_to_lower(df_festivals$nom_de_la_manifestation)
head(df_festivals_low)
```

```{r}
# Intersections des deux sources :
festivals_communs <- intersect(df_festivals_low, listes_festivals_low)
cat("Les festivals qui sont pr√©sents dans le JSON et dans la liste des festivals conseill√©s par le site internet sont", paste("\n", festivals_communs))
```

# Conclusion

Finalement, ce projet nous a permis de traiter des donn√©es de natures diff√©rentes. Ce projet a √©t√© d'autant plus agr√©able que nous avons choisi nos propres donn√©es, les festivals de musique √©lectronniques et amplifi√©es. Les donn√©es √©tant vari√©es, nous avons pu les illustrer √† travers des graphiques, une carte, la r√©cup√©ration d'images... Le projet se d√©clinant sur plusieurs √©chelles nous a permis de ne pas rendre le projet monotone et d'explorer plusieurs approches. En esp√©rant vous avoir donn√© envie d'aller danser sur des musiques √©lectroniques (comme nous l'avons vu, beaucoup de festivals se trouvent en Ille-et-Vilaine et la saison des beaux jours arrive ü•≥). 

